{% extends "base.html" %}

{% block title %}Calendar - Gatherly{% endblock %}

{% block content %}
<div class="scrollable-calendar-container">
    <!-- Header with today button -->
    <div class="calendar-header">
        <h1 class="calendar-title">Calendar</h1>
        <button id="todayBtn" class="btn btn-primary">Today</button>
    </div>
    
    <!-- Floating month header -->
    <div id="floatingMonthHeader" class="floating-month-header">
        September 2025
    </div>
    
    <!-- Day headers (sticky) -->
    <div class="sticky-day-headers">
        <div class="day-header">S</div>
        <div class="day-header">M</div>
        <div class="day-header">T</div>
        <div class="day-header">W</div>
        <div class="day-header">T</div>
        <div class="day-header">F</div>
        <div class="day-header">S</div>
    </div>
    
    <!-- Loading indicator -->
    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <div class="spinner"></div>
        <span>Loading calendar...</span>
    </div>
    
    <!-- Scrollable calendar content -->
    <div id="calendarScroll" class="calendar-scroll">
        <!-- Continuous calendar grid -->
        <div id="calendarGrid" class="calendar-grid-continuous">
            <!-- Week rows will be dynamically loaded here -->
        </div>
    </div>
    
    <!-- Bottom Menu Bar -->
    <div class="bottom-menu-bar">
        <a href="{{ url_for('availability.index') }}" class="menu-item {% if request.endpoint == 'availability.index' %}active{% endif %}">
            <div class="menu-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
                    <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2"/>
                    <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2"/>
                    <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
                </svg>
            </div>
            <span class="menu-label">Availability</span>
        </a>
        
        <a href="{{ url_for('groups.index') }}" class="menu-item {% if request.endpoint == 'groups.index' %}active{% endif %}">
            <div class="menu-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none"/>
                    <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
            </div>
            <span class="menu-label">Groups</span>
        </a>
        
        <a href="{{ url_for('events.index') }}" class="menu-item {% if request.endpoint == 'events.index' %}active{% endif %}">
            <div class="menu-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
            </div>
            <span class="menu-label">Events</span>
        </a>
        
        <a href="{{ url_for('friends.index') }}" class="menu-item {% if request.endpoint == 'friends.index' %}active{% endif %}">
            <div class="menu-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none"/>
                    <circle cx="8.5" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M20 8v6" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M23 11h-6" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
            </div>
            <span class="menu-label">Friends</span>
        </a>
    </div>
</div>

<style>
/* Prevent page scrolling */
body {
    overflow: hidden !important;
    height: 100vh;
    position: fixed;
    width: 100%;
}

.scrollable-calendar-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    background: var(--background); /* Match calendar background */
    border-bottom: 1px solid transparent; /* Invisible bottom border */
    flex-shrink: 0;
    z-index: 20;
}

.calendar-title {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.floating-month-header {
    position: sticky;
    top: 0;
    background: var(--background);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid transparent; /* Invisible border between month and weekdays */
    padding: var(--space-5) var(--space-4); /* Increased vertical padding */
    text-align: center;
    font-size: calc(var(--font-size-xl) * 2); /* Twice as big */
    font-weight: 600;
    color: var(--text-primary);
    z-index: 15;
    flex-shrink: 0;
}

.sticky-day-headers {
    position: sticky;
    top: 90px; /* Increased height for bigger month header */
    background: var(--background); /* Match calendar background */
    border-bottom: 1px solid var(--border); /* Keep border below weekdays */
    border-top: 1px solid transparent; /* Invisible top border */
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0;
    z-index: 10;
    flex-shrink: 0;
}

.sticky-day-headers .day-header {
    text-align: center;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: var(--space-2);
    background: var(--background); /* Match calendar background */
    border-right: 1px solid transparent; /* Completely invisible borders */
}

.sticky-day-headers .day-header:last-child {
    border-right: none;
}

.calendar-scroll {
    flex: 1;
    overflow-y: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    touch-action: pan-y;
}

.calendar-grid-continuous {
    background: transparent;
}

/* Continuous week rows */
.calendar-grid-continuous .week-row {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: 1fr;
    gap: 0;
    border-bottom: 1px solid var(--border);
    flex: 1;
}

.calendar-grid-continuous .week-row:last-child {
    border-bottom: none;
}

.calendar-grid-continuous .day-column {
    background: var(--background); /* Match weekday header background */
    border-right: 1px solid transparent; /* Completely invisible borders */
    padding: var(--space-3);
    min-height: calc((100vh - 200px) / 4 - 1px); /* 4 rows fit in viewport minus headers/padding */
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center; /* Center day numbers and friend bubbles */
}

.calendar-grid-continuous .day-column:last-child {
    border-right: none;
}

.calendar-grid-continuous .day-column:hover {
    background: rgba(0, 104, 177, 0.1);
    transform: translateY(-1px);
}

.calendar-grid-continuous .day-column.today {
    background: rgba(0, 104, 177, 0.15);
    border-right-color: transparent !important; /* Keep right border invisible even for today */
}

.calendar-grid-continuous .date-number {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-primary);
    margin-bottom: var(--space-2);
    width: 100%;
    text-align: center; /* Center the day numbers */
}

.calendar-grid-continuous .friend-block {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    /* Background color will be set by friend-color-X classes */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
    text-transform: uppercase;
    margin-bottom: var(--space-2);
    transition: all 0.2s ease;
    cursor: pointer;
    border: 2px solid transparent;
    flex-shrink: 0;
}

.calendar-grid-continuous .friend-block:hover {
    transform: scale(1.1);
    border-color: rgba(255, 255, 255, 0.3);
}

.calendar-grid-continuous .friend-block.current-user {
    background: white;
    color: black;
    border: 2px solid var(--primary);
}

/* User availability indicators */
.day-users {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    margin-top: var(--space-1);
}

.user-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.user-indicator.current-user {
    background: white;
    color: black;
    border: 2px solid var(--primary);
}

/* Friend colors */
.friend-color-0 { background: #3B82F6; }
.friend-color-1 { background: #EF4444; }
.friend-color-2 { background: #10B981; }
.friend-color-3 { background: #F59E0B; }
.friend-color-4 { background: #8B5CF6; }
.friend-color-5 { background: #EC4899; }
.friend-color-6 { background: #06B6D4; }
.friend-color-7 { background: #84CC16; }

/* Loading indicator */
.loading-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-4);
    color: var(--text-secondary);
}

.spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Bottom Menu Bar */
.bottom-menu-bar {
    position: fixed;
    bottom: 39px; /* Keep the 5mm upward movement */
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: var(--space-4);
    background: rgba(10, 14, 26, 0.8); /* Back to original semi-translucent background */
    backdrop-filter: blur(20px); /* Back to original blur */
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1); /* Back to original border */
    border-radius: 24px; /* Back to original border-radius */
    padding: var(--space-4) var(--space-5); /* Keep the increased padding for size */
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); /* Back to original shadow */
}

.menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
    text-decoration: none;
    color: white; /* Keep the pure white color */
    transition: all 0.2s ease; /* Back to original transition */
    padding: var(--space-3); /* Keep the increased padding for size */
    border-radius: var(--radius-md); /* Back to original border-radius */
    min-width: 65px; /* Keep the slightly wider size */
}

.menu-item:hover {
    color: white; /* Keep pure white on hover */
    background: rgba(255, 255, 255, 0.1); /* Back to original hover background */
    transform: translateY(-2px); /* Back to original lift amount */
}

.menu-item.active {
    color: var(--primary);
    background: rgba(0, 122, 255, 0.2); /* Back to original active background */
}

.menu-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.menu-label {
    font-size: var(--font-size-xs);
    font-weight: 500;
    text-align: center;
    white-space: nowrap;
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .bottom-menu-bar {
        bottom: 35px; /* Keep the 5mm upward movement on mobile */
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4); /* Keep the enhanced mobile padding for size */
    }
    
    .menu-item {
        min-width: 50px;
        gap: 4px;
    }
    
    .menu-icon {
        width: 20px;
        height: 20px;
    }
    
    .menu-label {
        font-size: 10px;
    }
    
    .calendar-grid-continuous .day-column {
        padding: var(--space-2);
        min-height: calc((100vh - 180px) / 4 - 1px); /* 4 rows fit in viewport minus headers/padding */
    }
    
    .calendar-grid-continuous .friend-block {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
    }
    
    .calendar-header {
        padding: var(--space-2) var(--space-3);
    }
    
    .calendar-title {
        font-size: var(--font-size-xl);
    }
    
    .floating-month-header {
        font-size: calc(var(--font-size-lg) * 1.5); /* Still bigger on mobile, but proportional */
        padding: var(--space-3) var(--space-3); /* Increased padding */
    }
    
    .sticky-day-headers {
        top: 70px; /* Adjusted for bigger floating header on mobile */
    }
    
    .sticky-day-headers .day-header {
        padding: var(--space-1);
        font-size: 0.75rem;
    }
}

@media (max-width: 480px) {
    .calendar-grid-continuous .day-column {
        padding: var(--space-1);
        min-height: calc((100vh - 160px) / 4 - 1px); /* 4 rows fit in viewport minus headers/padding */
    }
    
    .calendar-grid-continuous .friend-block {
        width: 24px;
        height: 24px;
        font-size: 0.65rem;
    }
}

/* Intersection observer target for infinite scroll */
.month-loader {
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Initialize scrollable calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (typeof initializeScrollableCalendar === 'function') {
        initializeScrollableCalendar();
    }
});
</script>
{% endblock %}
